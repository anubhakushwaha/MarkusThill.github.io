<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<!--<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML" type="text/javascript"></script>-->
<!--<script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script>-->
<head>
<script type="text/javascript" async
  src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
</script>
<script type="text/x-mathjax-config">MathJax.Hub.Config({ TeX: { equationNumbers: {autoNumber: "AMS"} } });</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.0/jquery.min.js"></script>
<script>
  function resizeIframe(obj) {
    obj.style.height = obj.contentWindow.document.body.scrollHeight + 'px';
  }
</script>

<meta charset="utf-8">
<title>Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT&#58; A Prototype &#8211; ML & Stats</title>
<meta name="description" content="Recently, the low-cost ESP8266 Wi-Fi chip family is becoming increasingly popular among hobbyists. The ESP8266 has microcontroller unit (MCU) onboard and it has a full TCP/IP stack which makes it a very interesting device for many IoT (Internet of Things) tasks. The chips are produced by the Chinese manufacturer, Espressif Systems, which is located in Shanghai. For this post I am using a simple module, the ESP8266-01, which basically only provides two general purpose input/output (GPIO) pins, but which is rather small and sufficient for the problem presented here. In this post we will take a look at the steps required to build a simple adapter-plug which can be turned on and off via the internet (or a local network) using a ESP8266 module and the MQTT protocol. The resulting adapter-plug will look like shown in the blog post.">
<meta name="keywords" content="IoT, Electronics, ESP8266">



<!-- Open Graph -->
<meta property="og:locale" content="en">
<meta property="og:type" content="article">
<meta property="og:title" content="Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT&#58; A Prototype">
<meta property="og:description" content="Recently, the low-cost ESP8266 Wi-Fi chip family is becoming increasingly popular among hobbyists. The ESP8266 has microcontroller unit (MCU) onboard and it has a full TCP/IP stack which makes it a very interesting device for many IoT (Internet of Things) tasks. The chips are produced by the Chinese manufacturer, Espressif Systems, which is located in Shanghai. For this post I am using a simple module, the ESP8266-01, which basically only provides two general purpose input/output (GPIO) pins, but which is rather small and sufficient for the problem presented here. In this post we will take a look at the steps required to build a simple adapter-plug which can be turned on and off via the internet (or a local network) using a ESP8266 module and the MQTT protocol. The resulting adapter-plug will look like shown in the blog post.">
<meta property="og:url" content="https://MarkusThill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/">
<meta property="og:site_name" content="ML & Stats">
<meta property="og:image" content="https://MarkusThill.github.io/images/819s.jpg">






<link rel="canonical" href="https://MarkusThill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/">
<link href="https://MarkusThill.github.io/feed.xml" type="application/atom+xml" rel="alternate" title="ML & Stats Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1.0, user-scalable=no"/>

<!-- For all browsers -->
<link rel="stylesheet" href="https://MarkusThill.github.io/assets/css/main.css">
<link rel="stylesheet" href="https://MarkusThill.github.io/assets/css/jquery.mmenu.all.css">
<link rel="stylesheet" href="https://MarkusThill.github.io/assets/css/jquery.floating-social-share.min.css">
<!-- Webfonts -->
<link href="//fonts.googleapis.com/css?family=Lato:300,400,700,300italic,400italic" rel="stylesheet" type="text/css">

<meta http-equiv="cleartype" content="on">

<!-- Load Modernizr -->
<script type="text/javascript" src="https://MarkusThill.github.io/assets/js/vendor/modernizr-2.6.2.custom.min.js"></script>

<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="https://MarkusThill.github.io/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="https://MarkusThill.github.io/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="https://MarkusThill.github.io/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="https://MarkusThill.github.io/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="https://MarkusThill.github.io/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="https://MarkusThill.github.io/images/apple-touch-icon-144x144-precomposed.png">




<!--<link rel="stylesheet" type="text/css" href="https://cdn.rawgit.com/dreampulse/computer-modern-web-font/master/fonts.css">-->
<link rel="stylesheet" href="/fonts/cmun-serif.css"></link>

<!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT: A Prototype | ML &amp; Stats</title>
<meta name="generator" content="Jekyll v3.8.6" />
<meta property="og:title" content="Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT: A Prototype" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Recently, the low-cost ESP8266 Wi-Fi chip family is becoming increasingly popular among hobbyists. The ESP8266 has microcontroller unit (MCU) onboard and it has a full TCP/IP stack which makes it a very interesting device for many IoT (Internet of Things) tasks. The chips are produced by the Chinese manufacturer, Espressif Systems, which is located in Shanghai. For this post I am using a simple module, the ESP8266-01, which basically only provides two general purpose input/output (GPIO) pins, but which is rather small and sufficient for the problem presented here. In this post we will take a look at the steps required to build a simple adapter-plug which can be turned on and off via the internet (or a local network) using a ESP8266 module and the MQTT protocol. The resulting adapter-plug will look like shown in the blog post." />
<meta property="og:description" content="Recently, the low-cost ESP8266 Wi-Fi chip family is becoming increasingly popular among hobbyists. The ESP8266 has microcontroller unit (MCU) onboard and it has a full TCP/IP stack which makes it a very interesting device for many IoT (Internet of Things) tasks. The chips are produced by the Chinese manufacturer, Espressif Systems, which is located in Shanghai. For this post I am using a simple module, the ESP8266-01, which basically only provides two general purpose input/output (GPIO) pins, but which is rather small and sufficient for the problem presented here. In this post we will take a look at the steps required to build a simple adapter-plug which can be turned on and off via the internet (or a local network) using a ESP8266 module and the MQTT protocol. The resulting adapter-plug will look like shown in the blog post." />
<link rel="canonical" href="https://markusthill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/" />
<meta property="og:url" content="https://markusthill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/" />
<meta property="og:site_name" content="ML &amp; Stats" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2017-10-12T19:55:53+02:00" />
<script type="application/ld+json">
{"description":"Recently, the low-cost ESP8266 Wi-Fi chip family is becoming increasingly popular among hobbyists. The ESP8266 has microcontroller unit (MCU) onboard and it has a full TCP/IP stack which makes it a very interesting device for many IoT (Internet of Things) tasks. The chips are produced by the Chinese manufacturer, Espressif Systems, which is located in Shanghai. For this post I am using a simple module, the ESP8266-01, which basically only provides two general purpose input/output (GPIO) pins, but which is rather small and sufficient for the problem presented here. In this post we will take a look at the steps required to build a simple adapter-plug which can be turned on and off via the internet (or a local network) using a ESP8266 module and the MQTT protocol. The resulting adapter-plug will look like shown in the blog post.","headline":"Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT: A Prototype","dateModified":"2017-10-12T19:55:53+02:00","datePublished":"2017-10-12T19:55:53+02:00","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://markusthill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/"},"publisher":{"@type":"Organization","logo":{"@type":"ImageObject","url":"https://markusthill.github.io/images/logo.png"}},"url":"https://markusthill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->

</head>

<body id="post" class="feature">

<!--[if lt IE 9]><div class="upgrade"><strong><a href="https://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->



<div class="header-menu header-menu-top">
    <ul class="header-item-container">
      <li class="header-item-title header-toggle "><a href="#menu"><h2><i class="fa fa-bars"></i></h2></a></li>
      <li class="header-item-title">
        <a href="https://MarkusThill.github.io/">
          
            <img class="logo" src="https://MarkusThill.github.io/images/logo.png" alt="ML & Stats">
          
          <a href="https://MarkusThill.github.io/" class="title"> ML & Stats</a>
        </a>
      </li>
      
        
        

        
            
                <li class="header-item "><a href="https://MarkusThill.github.io/posts"><h3>Posts</h3></a></li>
            
        
      
        
        

        
          <li class="header-item "><a href="https://MarkusThill.github.io/categories"><h3>Categories</h3></a>
            <ul class="header-submenu">
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#Electronics">Electronics</a></li>
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#ML">ML</a></li>
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#Math">Math</a></li>
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#Programming">Programming</a></li>
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#Stats">Stats</a></li>
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#Template">Template</a></li>
              
                
                  <li class="sub-item"><a href="https://MarkusThill.github.io/categories/#Vector Algebra">Vector Algebra</a></li>
              
            </ul>
          </li>
        
      
        
        

        
            
                <li class="header-item "><a href="https://MarkusThill.github.io/tags"><h3>Tags</h3></a></li>
            
        
      
        
        

        
            
                <li class="header-item "><a href="https://MarkusThill.github.io/markus"><h3>About</h3></a></li>
            
        
      
        
        

        
            
                <li class="header-item "><a href="https://MarkusThill.github.io/"><h3>Home</h3></a></li>
            
        
      
      <li class="header-item"><a href="https://MarkusThill.github.io/search"><h3><i class="fa fa-search"></i></h3></a></li>
    </ul>
  </div>
<div class="entry-header">
  <div class="header-title">
    <div class="header-title-wrap">
      <h1>Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT&#58; A Prototype</h1>
      
        <h2><span class="entry-date date published updated"><time datetime="2017-10-12T19:55:53+02:00">October 12, 2017</time></span></h2>
      

      
        <p class="entry-reading-time">
          <i class="fa fa-clock-o"></i>
          
          Reading time ~12 minutes
        </p><!-- /.entry-reading-time -->
      
    </div><!-- /.header-title-wrap -->
  </div><!-- /.header-title -->
</div><!-- /.entry-header -->


<nav id="menu" style="display: none">
  <ul>
    
      
        <li><a href="https://MarkusThill.github.io/"><h3>Home</h3></a></li>
      
    
      
        <li><a href="https://MarkusThill.github.io/markus"><h3>About</h3></a></li>
      
    
      
        <li><a href="https://MarkusThill.github.io/tags"><h3>Tags</h3></a></li>
      
    
      
        <li><a href="https://MarkusThill.github.io/categories"><h3>Categories</h3></a>
          <ul>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#Electronics">Electronics</a></li>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#ML">ML</a></li>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#Math">Math</a></li>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#Programming">Programming</a></li>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#Stats">Stats</a></li>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#Template">Template</a></li>
            
              
                <li><a href="https://MarkusThill.github.io/categories/#Vector Algebra">Vector Algebra</a></li>
            
          </ul>
        </li>
      
    
      
        <li><a href="https://MarkusThill.github.io/posts"><h3>Posts</h3></a></li>
      
    
  </ul>
</nav>




<div id="main" role="main">
  <article class="hentry">
    <div class="entry-content">
        
            <div class="entry-image-index">
              <img src="https://MarkusThill.github.io/images/819s.jpg" alt="Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT&#58; A Prototype">
              <div class="image-credit">Image source: <a target="_blank" href="https://www.freepik.com">Designed by xb100 / Freepik</a></div><!-- /.image-credit -->
            </div>
        
      <h1 class="post-title entry-title">Controlling an Adapter Plug with an ESP 8266-01 Wi-Fi Chip and MQTT&#58; A Prototype</h1>
      <p>In this post we will take a look at the steps required to build a simple adapter-plug which can be turned on and off via the internet (or a local network) using a ESP8266 module and the MQTT protocol. The resulting adapter-plug will look like this:</p>
<figure class="half">
	<img src="/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/electronics6.jpg" alt="" />
	<img src="/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/outlet_side.jpg" alt="" />
</figure>
<!--more-->

<p>Recently, the low-cost ESP8266 Wi-Fi chip family is becoming increasingly popular among hobbyists.
The ESP8266 has microcontroller unit (MCU) onboard and it has a full TCP/IP stack which makes it a very interesting device for many IoT (Internet of Things) tasks. The chips are produced by the Chinese manufacturer, Espressif Systems, which is located in Shanghai. For this post I am using a simple module, the ESP8266-01, which basically only provides two general purpose input/output (GPIO) pins, but which is rather small and sufficient for the problem presented here. The figure below shows the top view of the ESP-01.</p>
<figure class="half">
	<img src="/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/esp01v0.jpg" alt="" />
	<img src="/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/esp8266-01.jpg" alt="" />
</figure>
<p><em>Top view of the ESP8266-01 module. Images taken from <a href="https://www.sparkfun.com/products/13678">Sparkfun</a>. Images are CC by <a href="https://creativecommons.org/licenses/by/2.0/">2.0</a></em>
<!--more--></p>

<h2 id="wiring-of-the-esp8266-01">Wiring of the ESP8266-01</h2>

<p>The first and most important thing to note is that ESP8266 chip only uses 3.3V for power and I/O. Do not attempt to connect the ESP directly to 5V, since at best this may simply not work and – more likely – this will cause permanent damage to the chip. You have to be especially careful if you are using FTDI USB-to-TTL adapter cables, since they typically provide a VCC of 5V. If you use your own power supply, ensure that it provides more than 200mA (this requirement certainly also holds for your adapter cables and USB-ports of your computer). If not, you might observe very strange behavior of the ESP (such as random restarts).</p>

<p>If you are working with FTDI USB to TTL Adapter Cables that include PL-2303HX Chipset, there might be several issues with installing the driver of the adapter for Windows 7,8 and 10. For me, the description from <a href="https://www.ifamilysoftware.com/news37.html">https://www.ifamilysoftware.com/news37.html</a> solved the problems.</p>

<p>Typically, the ESP8266-01 is wired as illustrated in the following diagram:</p>

<p><img src="https://MarkusThill.github.io/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/esp8266_flash_prog_board_sch.png" alt="Wiring Diagram ESP 8266-01" />
<em>Image taken from <a href="https://www.esp8266.com/wiki/doku.php?id=getting-started-with-the-esp8266">https://www.esp8266.com/wiki/doku.php?id=getting-started-with-the-esp8266</a></em></p>

<p>As we can see, the ESP-01 version of this module has 8 pins: VCC, GND, CH_PD,TX, RX, RST, GPIO0, and GPIO1.
The following wiring is required to make everything work.</p>
<ul>
  <li>VCC is connected to 3.3V</li>
  <li>CH_PD has to be pulled-up (meaning it has to be connected to 3.3V as well; typically with a 1k OHM resistor). Do not forget this step, otherwise your ESP will not function.</li>
  <li>GND is connected to FTDI’s GND pin</li>
  <li>RX and TX are required for the serial communication with your computer. Note, that the wires are crossed when they are connected to the FTDI chip, hence:
    <ul>
      <li>RX is connected to FTDI’s TX pin</li>
      <li>TX is connected to FTDI’s RX pin</li>
    </ul>
  </li>
  <li>The RST pin is pulled up to 3.3V (with a 1k Ohm resistor) and will be reset if it is pulled down to ground with a switch (RESET switch in figure below). Also here do not forget the pull-up resistor, otherwise your ESP resets consistently.</li>
  <li>GPIO-0 should be connected to ground via a switch (PROG in above diagram). This is required to be able to flash the modul. During normal operation it can be used for other purposes.</li>
  <li>GPIO-1 stands at your free disposal</li>
</ul>

<p><img src="https://MarkusThill.github.io/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/20160503_172349.jpg" alt="Wiring of the ESP8266-01 on a breadboard" class="image-center" width="400px" /></p>
<center><it>Wiring of the ESP8266-01 on a breadboard.</it></center>

<h2 id="first-conversation-with-the-esp">First Conversation with the ESP</h2>

<p>In order to check if your wiring with a new ESP8266-01 works, you can use a standard terminal emulator to talk to the module, since it already comes with a flashed firmware. Note that once you flashed the ESP-01 modul yourself, it will not respond to AT commands (such as AT+GMR, AT+RST, etc.) any longer, since the initial firmware will be overwritten. Since the baud rate configuration is not consistent on the ESP-01 modul, you will most likely have to try different settings. The ones you want to try first are 9600 and 115200. Then 57600 and/or 76800 (38400 * 2). Try different baud rates, for some you might only see a sequence of unrecognizable symbols, for some nothing at all.
After resetting your ESP modul there should be a ”ready“ message at the selected baud rate if your UART Rx is wired correctly.
Once you find a working baud rate, you can send a first <code class="highlighter-rouge">AT</code> command to the module. The following AT command asks the module whether it is up. It should respond with OK.</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">  AT

  OK</code></pre></figure>

<p>Additionally, you can try the <code class="highlighter-rouge">AT+GMR</code> command, which should produce a result similar to this:</p>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">  AT+GMR

  AT version:0.40.0.0(Aug  8 2015 14:45:58)
  SDK version:1.3.0
  Ai-Thinker Technology Co.,Ltd.
  Build:1.3.0.2 Sep 11 2015 11:48:04
  OK</code></pre></figure>

<p>The AT command set is quite large, a table containing the commands (e.g. in order to set up the WiFi) can be found <a href="https://nurdspace.nl/ESP8266#AT_Commands">here</a>. You can already do quite a lot with this basic firmware installed on the ESP.</p>

<h2 id="a-simple-test-program-using-the-arduino-ide">A simple Test Program using the Arduino IDE</h2>

<p>With a few steps it is possible to use the Arduino IDE for programming the ESP8266 moduls. Check out <a href="https://www.whatimade.today/esp8266-easiest-way-to-program-so-far/">this website</a> for an installation guide. There are also many other guides for setting up the Arduino IDE for usage with the 8266 family on the web.
Once you set-up your Arduino environment, you might want to try this first simple test program that blinks a LED.</p>

<p>The wiring for this setup is rather easy and shown in the following diagram.</p>

<p><img src="https://MarkusThill.github.io/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/lochmaster.png" alt="TODO" class="image-center" /><br />
<em>Connecting a LED to the GPIO-2 pin of the ESP8266 modul.
Note that the connection diagram shown here is simplified and does
not include the additional connections that are typically required
(TxD, RxD) to flash a program to the device. Figure taken from <a href="https://iot-playground.com/blog/2-uncategorised/38-esp8266-and-arduino-ide-blink-example">iot-playground.com</a></em></p>

<p>In order to see the result, connect a LED via the GPIO-2 pin and a resistor (typically between 220-330 Ohm; but do your calculations to be sure) to ground (as shown in above figure). After you have done the wiring, you can flash the ESP8266-01 with the following simple program, which should make the LED blink in short intervals.</p>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="kt">int</span> <span class="n">ledPin</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span> <span class="n">HIGH</span><span class="p">);</span>   <span class="c1">// turn the LED on (HIGH is the voltage level)</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>                   <span class="c1">// wait for 500ms</span>
  <span class="n">digitalWrite</span><span class="p">(</span><span class="n">ledPin</span><span class="p">,</span> <span class="n">LOW</span><span class="p">);</span>    <span class="c1">// turn the LED off by making the voltage LOW</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">1000</span><span class="p">);</span>                  <span class="c1">// wait for a second</span>
<span class="p">}</span></code></pre></figure>

<!--![TODO](https://MarkusThill.github.io/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/20160503_173908.jpg)-->

<h2 id="circuit-for-controlling-the-adapter-plug">Circuit for Controlling the Adapter Plug</h2>

<p>Now, after you are sure that your ESP is working as desired and you are comfortable in programming it, let us take a look at the circuit required for our adapter plug. If you are going to work with high voltages, extreme caution is required. Make sure that contacts with high voltages are not exposed. If you are not confident enough to work with the mains voltage, you can still make the circuit work and use it to switch lower voltages. First, let us look at the layout of the stripboard:</p>

<p><img src="https://MarkusThill.github.io/images/2017-10-12-control-an-adapter-plug-with-an-esp8266-and-mqtt/lochmaster2.png" alt="Layout of the stripboard" /></p>

<ul>
  <li>The circuit has to be provided with a supply voltage of 5V (Top left corner). Make sure that the power supply can provide currents of at least 500mA. I found a power supply which is quite small and fits into the package of the adapter plug</li>
  <li>Since the ESP-01 modul requries 3.3V, we need a regulator (LM1117T) that transforms the supplied 5V voltage.</li>
  <li>The ESP-01 modul is plugged into the socket shown in the upper-middle part of the diagram</li>
  <li>The button S1 (RST) is used to reset the ESP-01.</li>
  <li>The button S2 has two functions: Firstly, it is used to put the ESP into program-mode (press S1 - press S2 - release S2 - release S1). During normal operation the button is used to turn on/off the outlet manually.</li>
  <li>The transistor T2 (e.g., D1163A or comparable) is used to drive the relay. Basically any NPN transistor can be used. However, make sure that it can provide currents sufficient for the relay. Furthermore, notice, that a diode D2 is - required in parallel to the relay to prevent circuit damages due to the inductive component.</li>
  <li>The LED D1 will indicate the current state of the adapter plug (on or off)</li>
  <li>We noticed that the ESP cannot initialize after being turned on, when the base of T2 is directly connected to the GPIO2 pin. The reason for this could be that the GPIO2 pin is set to HIGH during initialization which would directly activate the relais via T2. But somehow the ESP modul cannot tolerate any electrical loads during the initialization phase. For this reason we introduced a second transistor T1 (BC547) with a capacitor (10uF) that delays HIGH-signals on GPIO2 for about a second. When the circuit is turned on, the ESP modul will initialize and during this time set its GPIO2 pin to HIGH. With the current that flows through R5 (470 kilo-Ohm) the capacitor (10uF) will gradually charge. In the beginning the potential on the base of T1 will therefor be 0V and the Collector-Emitter current flow through the transistor will be blocked. If the voltage in the capacitor reaches a sufficient voltage, T1 will activate and T2 can then turn on the relay.</li>
  <li>The green pin header in the figure is connected to a FTDI device in order to program the ESP-01 via the serial interface.</li>
  <li>Note that the ESP-01 operates in voltage ranges of 0V – 3.3V. Hence, you have to make sure that your FTDI converter operates in the same range as well; otherwise you will destroy the ESP-01 modul.</li>
</ul>

<p>The following images show how the circuit board and the final adapter plug could look like:</p>
<iframe class="slideshow-iframe" src="https://MarkusThill.github.io/slides/controlAdapterPlug.html" style="width:100%" frameborder="0" scrolling="no" onload="resizeIframe(this)"></iframe>

<h2 id="source-code">Source code</h2>
<p>So now we just need some program, which can be used to control the adapter plug via MQTT.</p>

<hr />

<div class="github-sample-reference">
  <div class="author-info">
    <a href="https://github.com/MarkusThill/ESP8266/blob/master/adapterPlug/adapterPlug.ino">This Github Sample</a> is by <a href="https://github.com/MarkusThill">MarkusThill</a>
  </div>
  <div class="meta-info">
    adapterPlug/adapterPlug.ino <a href="https://github.com/MarkusThill/ESP8266/blob/master/adapterPlug/adapterPlug.ino">view</a> <a href="https://raw.githubusercontent.com/MarkusThill/ESP8266/master/adapterPlug/adapterPlug.ino">raw</a>
  </div>
</div>

<figure class="highlight"><pre><code class="language-c" data-lang="c"><span class="cp">#include &lt;ESP8266WiFi.h&gt;
</span> <span class="cp">#include &lt;PubSubClient.h&gt;
</span> <span class="cp">#include &lt;string.h&gt;
</span> <span class="cp">#define SLEEP_DELAY_IN_SECONDS  10
</span> <span class="cp">#define TOPIC_ROOT "diedackel/f"
</span> <span class="cp">#define DEVICE_ID  "plug-02"
</span> <span class="cp">#define SLASH "/"
</span> <span class="cp">#define CMD_RELAIS_ON "device=on"
</span> <span class="cp">#define CMD_RELAIS_OFF "device=off"
</span> <span class="cp">#define STR_CONFIRM_STATE "confirmNewState="
</span>

<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">ssid</span> <span class="o">=</span> <span class="s">"FusulFusul"</span><span class="p">;</span> <span class="c1">// dlink-C148, FusulFusul</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">password</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span> <span class="c1">// , </span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_server</span> <span class="o">=</span> <span class="s">"io.adafruit.com"</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_username</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_password</span> <span class="o">=</span> <span class="s">""</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_pubs_topic</span> <span class="o">=</span> <span class="n">TOPIC_ROOT</span> <span class="n">SLASH</span> <span class="n">DEVICE_ID</span><span class="p">;</span>
<span class="k">const</span> <span class="kt">char</span><span class="o">*</span> <span class="n">mqtt_subs_topic</span> <span class="o">=</span> <span class="n">TOPIC_ROOT</span> <span class="n">SLASH</span> <span class="n">DEVICE_ID</span><span class="p">;</span>
<span class="n">WiFiClient</span> <span class="n">espClient</span><span class="p">;</span>
<span class="n">PubSubClient</span> <span class="nf">client</span><span class="p">(</span><span class="n">espClient</span><span class="p">);</span>

<span class="c1">// GPIO-pin 2, used for activating the relais</span>
<span class="kt">int</span> <span class="n">GPIO2</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
<span class="c1">// GPIO-pin 0, used as input for manually turning on/off the relais</span>
<span class="kt">int</span> <span class="n">GPIO0</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="c1">// State of the relais</span>
<span class="kt">int</span> <span class="n">state</span> <span class="o">=</span> <span class="n">LOW</span><span class="p">;</span>
<span class="c1">// Flag used for debouncing the push-button</span>
<span class="n">bool</span> <span class="n">debounce</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="cm">/*
 * Called once during the initialization phase after reset
 ****/</span>
<span class="kt">void</span> <span class="nf">setup</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// First allow interrupts. So we can turn on the plug, even if we dont have WiFi</span>
  <span class="c1">// GPIO0 will be an input that is used to turn on the relais using a button</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">GPIO0</span><span class="p">,</span> <span class="n">INPUT</span><span class="p">);</span>
  <span class="n">attachInterrupt</span><span class="p">(</span><span class="n">GPIO0</span><span class="p">,</span> <span class="n">fallingEdge</span><span class="p">,</span> <span class="n">FALLING</span><span class="p">);</span>
  
  <span class="c1">// setup serial port</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="mi">115200</span><span class="p">);</span>
  <span class="c1">// setup WiFi</span>
  <span class="n">setup_wifi</span><span class="p">();</span>
  <span class="n">client</span><span class="p">.</span><span class="n">setServer</span><span class="p">(</span><span class="n">mqtt_server</span><span class="p">,</span> <span class="mi">1883</span><span class="p">);</span>
  <span class="n">client</span><span class="p">.</span><span class="n">setCallback</span><span class="p">(</span><span class="n">callback</span><span class="p">);</span>
  <span class="c1">// setup pins</span>
  <span class="c1">// GPIO2 will be used to activate the relais</span>
  <span class="n">pinMode</span><span class="p">(</span><span class="n">GPIO2</span><span class="p">,</span> <span class="n">OUTPUT</span><span class="p">);</span>
  <span class="c1">//pinMode(LED_BUILTIN, OUTPUT); // Does not work. Maybe same pin as TX/RX line?</span>
<span class="p">}</span>
<span class="kt">void</span> <span class="nf">fallingEdge</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="n">debounce</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="o">!</span><span class="n">state</span><span class="p">;</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">GPIO2</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">debounce</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="c1">// Do not call other functions in this interrupt (such as delay, etc.). This only causes problems.</span>
<span class="p">}</span>

<span class="kt">void</span> <span class="nf">setup_wifi</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">10</span><span class="p">);</span>
  <span class="c1">// We start by connecting to a WiFi network</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"Connecting to "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">ssid</span><span class="p">);</span>
  <span class="n">WiFi</span><span class="p">.</span><span class="n">begin</span><span class="p">(</span><span class="n">ssid</span><span class="p">,</span> <span class="n">password</span><span class="p">);</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"."</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">""</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"WiFi connected"</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"IP address: "</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">localIP</span><span class="p">());</span>
<span class="p">}</span>
 <span class="cm">/*
  * MQTT callback function. It is always called with we receive a message on the subscribed topics.
  * The topic itself is given as a parameter of the function.
  ****/</span>
<span class="kt">void</span> <span class="nf">callback</span><span class="p">(</span><span class="kt">char</span><span class="o">*</span> <span class="n">topic</span><span class="p">,</span> <span class="n">byte</span><span class="o">*</span> <span class="n">payload</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">length</span><span class="p">)</span> <span class="p">{</span>
  <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">string</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="kt">char</span> <span class="n">lowerString</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>

  <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"Message arrived [%s] "</span><span class="p">,</span> <span class="n">topic</span><span class="p">);</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
  
  <span class="c1">// Copy the payload into a C-String and convert all letters into lower-case</span>
  <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">length</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="kt">char</span><span class="p">)</span><span class="n">payload</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="n">lowerString</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">tolower</span><span class="p">(</span><span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]);</span>
  <span class="p">}</span>
  <span class="n">string</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="n">lowerString</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span>
  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">lowerString</span><span class="p">);</span>

  <span class="c1">// If the paylaod contains one of the predefined messages then turn on/off the relais</span>
  <span class="kt">uint8_t</span> <span class="n">newState</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">lowerString</span><span class="p">,</span> <span class="n">CMD_RELAIS_ON</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">newState</span> <span class="o">=</span> <span class="n">HIGH</span><span class="p">;</span>
  <span class="k">else</span> <span class="k">if</span><span class="p">(</span><span class="n">strcmp</span><span class="p">(</span><span class="n">lowerString</span><span class="p">,</span> <span class="n">CMD_RELAIS_OFF</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
     <span class="n">newState</span> <span class="o">=</span> <span class="n">LOW</span><span class="p">;</span>

   
  <span class="k">if</span><span class="p">(</span><span class="n">newState</span> <span class="o">==</span> <span class="n">LOW</span> <span class="o">||</span> <span class="n">newState</span> <span class="o">==</span> <span class="n">HIGH</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">state</span> <span class="o">=</span> <span class="n">newState</span><span class="p">;</span>
    <span class="n">digitalWrite</span><span class="p">(</span><span class="n">GPIO2</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"%s%d"</span><span class="p">,</span> <span class="n">STR_CONFIRM_STATE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="n">msg</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">mqtt_pubs_topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">);</span>
  <span class="p">}</span>  

  <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">();</span>
<span class="p">}</span>
<span class="cm">/*
 * Can be used to reconnect to the MQTT-Broker, in case we loose the connection inbetween
 ****/</span>
<span class="kt">void</span> <span class="nf">reconnect</span><span class="p">()</span> <span class="p">{</span>
  <span class="c1">// Loop until we're reconnected</span>
  <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">i</span><span class="o">++&lt;</span><span class="mi">10</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Attempting MQTT connection..."</span><span class="p">);</span>
    <span class="c1">// Attempt to connect</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connect</span><span class="p">(</span><span class="n">DEVICE_ID</span><span class="p">,</span> <span class="n">mqtt_username</span><span class="p">,</span> <span class="n">mqtt_password</span><span class="p">))</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"connected"</span><span class="p">);</span>
      <span class="c1">// Subscribe to a topic</span>
      <span class="k">if</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">mqtt_subs_topic</span><span class="p">))</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Subscribed to the specified topic"</span><span class="p">);</span>
      <span class="k">else</span>
        <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"Failed to subscribe to the specified topic"</span><span class="p">);</span>
      <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">mqtt_pubs_topic</span><span class="p">,</span> <span class="s">"Hello, here I am..."</span><span class="p">);</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="s">"failed, rc="</span><span class="p">);</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">print</span><span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">state</span><span class="p">());</span>
      <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">" trying again in 500 mseconds"</span><span class="p">);</span>
      <span class="c1">// Wait 500 seconds before retrying</span>
      <span class="n">delay</span><span class="p">(</span><span class="mi">500</span><span class="p">);</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>
<span class="cm">/*
 * This function will be called after setup() in an infinite loop
 ****/</span>
<span class="kt">void</span> <span class="nf">loop</span><span class="p">()</span> <span class="p">{</span>
  <span class="k">static</span> <span class="kt">int</span> <span class="n">loopCounter</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">loopCounter</span><span class="o">++</span><span class="p">;</span>
  <span class="kt">char</span> <span class="n">msg</span><span class="p">[</span><span class="mi">50</span><span class="p">];</span>
  <span class="k">if</span><span class="p">(</span><span class="n">WiFi</span><span class="p">.</span><span class="n">status</span><span class="p">()</span> <span class="o">!=</span> <span class="n">WL_CONNECTED</span><span class="p">)</span> <span class="p">{</span>
    <span class="n">setup_wifi</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">reconnect</span><span class="p">();</span>
  <span class="p">}</span>

  <span class="k">if</span><span class="p">(</span><span class="n">loopCounter</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// Message every minute</span>
    <span class="n">Serial</span><span class="p">.</span><span class="n">println</span><span class="p">(</span><span class="s">"I am still alive..."</span><span class="p">)</span> <span class="p">;</span>
  <span class="p">}</span>
    
  <span class="c1">// send message to the MQTT topic</span>
  <span class="c1">//client.publish(mqtt_pubs_topic, "I am still alive...");</span>

  <span class="c1">// Example of a retained message</span>
  <span class="c1">//client.publish(mqtt_topic, "This will be retained", true);</span>
  <span class="n">client</span><span class="p">.</span><span class="n">loop</span><span class="p">();</span>
  <span class="n">delay</span><span class="p">(</span><span class="mi">300</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="n">client</span><span class="p">.</span><span class="n">connected</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="n">debounce</span> <span class="o">||</span> <span class="n">loopCounter</span> <span class="o">%</span> <span class="mi">200</span> <span class="o">==</span> <span class="mi">0</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">sprintf</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="s">"%s%d"</span><span class="p">,</span> <span class="n">STR_CONFIRM_STATE</span><span class="p">,</span> <span class="n">state</span><span class="p">);</span>
    <span class="n">client</span><span class="p">.</span><span class="n">publish</span><span class="p">(</span><span class="n">mqtt_pubs_topic</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="nb">true</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="c1">// After two seconds we can be sure that the button is debounced. The interrupt can also</span>
  <span class="c1">// come during the delay, but it unlikely to happen exactly (few ns) before the delay is over.</span>
  <span class="n">debounce</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
<span class="p">}</span></code></pre></figure>

<h2 id="usage">Usage</h2>

<p>Once the ESP-01 is flashed with the above program, there are basically two possibilities to turn on and off the electrical outlet:</p>
<ol>
  <li>You may use the button S2 to toggle the outlet. With every impulse generated by the button the state of the relay is inverted.</li>
  <li>MQTT: You can use a MQTT client to publish messages to a specified topic and control the outlet with these messages. For example (see definitions in the above code), the following configuration could be used (requires some adjustments in the above code):</li>
</ol>

<figure class="highlight"><pre><code class="language-plaintext" data-lang="plaintext">MQTT-Broker:        iot.eclipse.org
Port:               1883
Topic:              gf3heTS11c/plug-01
Accepted Messages:  DEVICE=ON
                    DEVICE=OFF</code></pre></figure>

<h2 id="future-work">Future work</h2>

<p>Although this prototype is already working quite well, there is still some work that can be done:</p>
<ul>
  <li>Request current state of the outlet via MQTT</li>
  <li>Instead of a standard relay one could use bi-stable relay. This would save some energy and would take load off the power supply</li>
  <li>Addressing and communication scheme for more complex scenarios</li>
  <li>Smart-phone App for managing the outlets and other MQTT-capable devices</li>
  <li>Integration into larger smart-home solutions</li>
</ul>

      <footer class="entry-meta">
        <span class="entry-tags"><a href="https://MarkusThill.github.io/tags#IoT" title="Pages tagged IoT" class="tag"><span class="term">IoT</span></a><a href="https://MarkusThill.github.io/tags#Electronics" title="Pages tagged Electronics" class="tag"><span class="term">Electronics</span></a><a href="https://MarkusThill.github.io/tags#ESP8266" title="Pages tagged ESP8266" class="tag"><span class="term">ESP8266</span></a></span>
        
        <span class="author vcard"><span class="fn">Markus Thill</span></span>
        <div class="social-share">
  <ul class="socialcount socialcount-small inline-list">
    <li class="facebook"><a href="https://www.facebook.com/sharer/sharer.php?u=https://MarkusThill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/" title="Share on Facebook"><span class="count"><i class="fa fa-facebook-square"></i> Like</span></a></li>
    <li class="twitter"><a href="https://twitter.com/intent/tweet?text=https://MarkusThill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/" title="Share on Twitter"><span class="count"><i class="fa fa-twitter-square"></i> Tweet</span></a></li>
    <li class="googleplus"><a href="https://plus.google.com/share?url=https://MarkusThill.github.io/programming/electronics/control-an-adapter-plug-with-an-esp8266-and-mqtt/" title="Share on Google Plus"><span class="count"><i class="fa fa-google-plus-square"></i> +1</span></a></li>
  </ul>
</div><!-- /.social-share -->

      </footer>
    </div><!-- /.entry-content -->
    <div class="read-more">
  <div class="read-more-header">
    <a href="https://MarkusThill.github.io/markus" class="read-more-btn">About the Author</a>
  </div><!-- /.read-more-header -->
  <div class="read-more-content author-info">
    <h3>Markus Thill</h3>
    <div class="author-container">
      <img class="author-img" src="https://MarkusThill.github.io/images/avatar.jpg" alt="Markus Thill" />
      <div class="author-bio">I studied computer engineering (B.Sc.) and Automation & IT (M.Eng.). Generally, I am interested in machine learning (ML) approaches (in the broadest sense), but particularly in the fields of time series analysis, anomaly detection, Reinforcement Learning (e.g. for board games), Deep Learning (DL) and incremental (on-line) learning procedures. </div>
    </div>
    <div class="author-share">
      <ul class="list-inline social-buttons">
        
          <li><a href="https://github.com/markusthill" target="_blank"><i class="fa fa-github fa-fw"></i></a></li>
        
          <li><a href="https://www.linkedin.com/in/markus-thill-a4991090/" target="_blank"><i class="fa fa-linkedin fa-fw"></i></a></li>
        
      </ul>
      
        <a aria-label="Follow @MarkusThill on GitHub" data-size="large" href="https://github.com/MarkusThill" class="github-button">Follow @MarkusThill</a>
      
      <br>
      
    </div>
  </div>
</div>

    <section id="disqus_thread"></section><!-- /#disqus_thread -->
    <div class="read-more">
  
    <div class="read-more-header">
      <a href="https://MarkusThill.github.io/ml/programming/zalandos-fashion-mnist-dataset/" class="read-more-btn">Read More</a>
    </div><!-- /.read-more-header -->
    <div class="read-more-content">
      <h3><a href="https://MarkusThill.github.io/deriving-a-closed-form-solution-of-the-fibonacci-sequence/" title="Deriving a Closed-Form Solution of the Fibonacci Sequence using the Z-Transform">Deriving a Closed-Form Solution of the Fibonacci Sequence using the Z-Transform</a></h3>
      <p>The Fibonacci sequence might be one of the most famous sequences in the field of mathmatics and computer science. Already high school stu...&hellip; <a href="https://MarkusThill.github.io/deriving-a-closed-form-solution-of-the-fibonacci-sequence/">Continue reading</a></p>
    </div><!-- /.read-more-content -->
  
  <div class="read-more-list">
    
      <div class="list-item">
        <h4><a href="https://MarkusThill.github.io/derivation-of-a-weighted-recursive-least-squares-estimator/" title="Derivation of a Weighted Recursive Linear Least Squares Estimator">Derivation of a Weighted Recursive Linear Least Squares Estimator</a></h4>
        <span>Published on May 05, 2019</span>
      </div><!-- /.list-item -->
    
      <div class="list-item">
        <h4><a href="https://MarkusThill.github.io/gaussian-distribution-with-a-diagonal-covariance-matrix/" title="Gaussian Distribution With a Diagonal Covariance Matrix">Gaussian Distribution With a Diagonal Covariance Matrix</a></h4>
        <span>Published on May 04, 2019</span>
      </div><!-- /.list-item -->
    
  </div><!-- /.read-more-list -->
</div><!-- /.read-more -->
  </article>
</div><!-- /#main -->

<script type="text/javascript" src="//ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script type="text/javascript">window.jQuery || document.write('<script type="text/javascript" src="https://MarkusThill.github.io/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script type="text/javascript" src="https://MarkusThill.github.io/assets/js/scripts.min.js"></script>
<script type="text/javascript" async defer id="github-bjs" src="https://buttons.github.io/buttons.js"></script>
<script type="text/javascript">!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^https:/.test(d.location)?'https':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>



<!-- Asynchronous Google Analytics snippet -->
<script type="text/javascript">
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-113918188-1', 'auto');
  ga('require', 'linkid', 'linkid.js');
  ga('send', 'pageview');
</script>



    <script type="text/javascript">
        /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
        var disqus_shortname = 'markusthill-github-io'; // required: replace example with your forum shortname

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function() {
            var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
            dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
            (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
        })();

        /* * * DON'T EDIT BELOW THIS LINE * * */
        (function () {
            var s = document.createElement('script'); s.async = true;
            s.type = 'text/javascript';
            s.src = '//' + disqus_shortname + '.disqus.com/count.js';
            (document.getElementsByTagName('HEAD')[0] || document.getElementsByTagName('BODY')[0]).appendChild(s);
        }());
    </script>
    <noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
    <a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>




<script type="text/javascript">
    sharing();
</script>



<div class="footer-wrapper">
  <footer role="contentinfo">
    <span>&copy; 2019 Markus Thill. Powered by <a href="https://jekyllrb.com" rel="nofollow">Jekyll</a> using the <a href="https://github.com/aron-bordin/neo-hpstr-jekyll-theme" rel="nofollow">Neo-HPSTR Theme</a>.</span>

  </footer>
</div><!-- /.footer-wrapper -->

</body>
</html>
